<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <title> Cerebraton </title>
        <link href='https://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type ="text/css"
              href="css/estiloNivel.css">
        <script src="js/jquery-1.11.3.js" type="text/javascript"></script>
        <script type="text/javascript">
            var puntaje = parseInt(localStorage["puntaje"]);
            var correcta;
            var contador = 1;
            var timeLeft;
            var preguntasMostradas = new Array(12);
            var aciertos = 0;


            function evaluarOpcion(opcion){
                if(opcion === correcta){
                    puntaje += 100;
                    aciertos++;
                }else if(puntaje > 0){
                    puntaje -= 50;
                }

                document.getElementById("puntos").innerHTML = puntaje;
                contador++;
                if(contador < 13){
                    changeQuestion();
                }else{
                    puntaje += (timeLeft / 10);
                    localStorage["puntaje"] = puntaje;
                    location.replace("bonusQuestion.html");
                }
            }

            function formatTime(sec_num) {
                var hours = Math.floor(sec_num / 3600);
                var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
                var seconds = Math.floor(sec_num - (hours * 3600) - (minutes * 60));

                var hourSeparator = ':';
                var minuteSeparator = ':';

                if (hours == 0) { hours = ''; hourSeparator = ''; }
                if (minutes < 10 && hours != 0) { minutes = "0" + minutes; }
                if (seconds < 10) { seconds = "0" + seconds; }
                var time = hours + hourSeparator + minutes + minuteSeparator + seconds;
                return time;
            }

            $(document).ready(function () {
                var temas = ["Historia", "Matemáticas"];
                var contador = 1;
                var pregunta;
                var respuesta;


                $.getJSON('json/input.json', function (contenidoArchivo) {
                    var indice = Math.floor((Math.random()*12));
                    preguntasMostradas[contador-1] = indice;
                    document.getElementById("tema").innerHTML = contenidoArchivo.Preguntas[indice].materia;
                    document.getElementById("numero").innerHTML = contador;
                    document.getElementById("texto").innerHTML = contenidoArchivo.Preguntas[indice].pregunta;

                    correcta = contenidoArchivo.Preguntas[indice].Respuesta;
                    for (var i = 0; i < 4; i++) {
                        var opcion = document.getElementById("opcion" + (i + 1));
                        opcion.innerHTML = contenidoArchivo.Preguntas[indice].Opciones[i];
                    }

                    var deadline = Date.now() + 1000 * parseInt(contenidoArchivo.tiempo); //60 segundos
                    function timer()
                    {
                        timeLeft = deadline - Date.now();
                        var $timerElement = $("#timer");
                        $timerElement.text(formatTime(timeLeft / 1000));

                        if (timeLeft > 0) {
                            setTimeout(timer, 50);
                        }
                        else
                        {
                            guardar();
                            location.replace("ResultadosNivel1.html");

                        }
                    }

                    timer();
                });
            });

            function changeQuestion(){
                $.getJSON('json/input.json', function (contenidoArchivo) {
                    if(contador <= 12){

                    do{
                        var indice = Math.floor((Math.random()*12));
                    }while(verificarPregunta(indice));

                    preguntasMostradas[contador-1] = indice;
                    document.getElementById("tema").innerHTML = contenidoArchivo.Preguntas[indice].materia;
                    document.getElementById("numero").innerHTML = contador;
                    document.getElementById("texto").innerHTML = contenidoArchivo.Preguntas[indice].pregunta;

                    correcta = contenidoArchivo.Preguntas[indice].Respuesta;
                    for (var i = 0; i < 4; i++) {
                        var opcion = document.getElementById("opcion" + (i + 1));
                        opcion.innerHTML = contenidoArchivo.Preguntas[indice].Opciones[i];
                    }

                    }else{

                        guardar();
                        location.replace("ResultadosNivel1.html");
                    }
                });
            }


            function verificarPregunta(numero){
                var resultado = false;

                for(var i =0; i < contador; i++){
                    if(preguntasMostradas[i]===numero){
                        resultado =  true;
                    }
                }

                return resultado;
            }


            function guardar(){
                var tp = timeLeft/1000;

                var resultados = {
                    aciertos: aciertos,
                    tiempo: tp,
                    bono:0
                };
                localStorage ["resultados"] = JSON.stringify(resultados);

                if(localStorage.getItem("max_puntuaciones") === null){
                    var puntuaciones = {
                        puntuaciones:[{
                                usuario: localStorage["usuario_actual"],
                                puntuacion: puntaje
                        },{
                                usuario: "anonimo",
                                puntuacion: 0
                        },{
                                usuario: "anonimo",
                                puntuacion: 0
                        },{
                                usuario: "anonimo",
                                puntuacion: 0
                        },{
                                usuario: "anonimo",
                                puntuacion: 0
                        }]
                    };

                    localStorage.setItem("max_puntuaciones", JSON.stringify(puntuaciones));
                }else{
                    var max = {};
                    var temp1, temp2, start;
                    max = JSON.parse(localStorage.getItem("max_puntuaciones"));
                    for(var i = 0; i < 5; i++){
                        if(max.puntuaciones[i].puntuacion < puntaje){
                            temp1 = max.puntuaciones[i].puntuacion;
                            temp2 = max.puntuaciones[i].usuario;
                            start = i;
                            max.puntuaciones[i].puntuacion = puntaje;
                            max.puntuaciones[i].usuario = localStorage["usuario_actual"];
                            break;
                        }
                    }

                    for(var i = start + 1; i < 5; i++){
                        var temp3 = max.puntuaciones[i].puntuacion;
                        var temp4 = max.puntuaciones[i].usuario;
                        max.puntuaciones[i].puntuacion = temp1;
                        max.puntuaciones[i].usuario = temp2;
                        temp1 = temp3;
                        temp2 = temp4;
                    }

                    localStorage.setItem("max_puntuaciones", JSON.stringify(max));
                }
            }

        </script>
    </head>
    <body>

        <div id="header">
            <div id="logo">
                <img src="./img/cerebro.jpg" style="width: 60px; height: 60px;" /><img src="./img/cerebro.png" id="letras" />
            </div>
            <div id="infoNivel">
                <h2>Nivel 1</h2>
                <div id="indicadores">
                    <table>
                        <tr>
                            <td style="text-align: left;"><span>Tiempo:</span></td>
                            <td style="text-align: right;"><span id="timer">0:00</span></td>
                        </tr>
                        <tr>
                            <td style="text-align: left;"><span>Puntos:</span></td>
                            <td style="text-align: right;"><span id="puntos">0</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div align="center" class="opciones">
            <div id="infoPregunta">
                <span id="tema" style=" float: left;"></span>
                <span id="numero" style="float: right;"></span>
            </div>
            <div id="card">
                <span id="texto"></span>
            </div>
            <div class="opcion" id="opcion1" onclick="evaluarOpcion('1')"></div>
            <div class="opcion" id="opcion2" onclick="evaluarOpcion('2')"></div>
            <div class="opcion" id="opcion3" onclick="evaluarOpcion('3')"></div>
            <div class="opcion" id="opcion4" onclick="evaluarOpcion('4')"></div>
        </div>

        <br/>

        <div id="creditos">
            <table width="100%">
                <tr>
                    <td align=center colspan="3" id="direccion">Campus Ciudad de M&eacute;xico
                        Calle del Puente #222 Col. Ejidos de Huipulco, Tlalpan C.P. 14380, M&eacute;xico D.F. | 5483 2020 D.R. &copy;
                        Instituto Tecnol&oacute;gico y de Estudios Superiores de Monterrey, M&eacute;xico. 2015.
                    </td>
                </tr>
            </table>
        </div>
    </body>
</html>